---
layout:     post                    
title:      计算机网络学习        
subtitle:    igmp组成员管理协议分析
date:       2019-12-19             
author:     BY shahur                     
catalog: true                       
tags:                              
    - 计算机网络
    - IGMP
---
# igmp组成员管理协议分析
## 基本概述
igmp用于主机（组播成员）和最后一跳路由器支架。  
主机使用igmp报文向路由器申请加入和退出组播组。默认时，路由器是不会向接口下转发组播数据流，除非该接口存在组成员。  
路由器通过igmp查询网段是否有组播组成员。 
igmp报文采用ip封装，协议号为2，ttl字段通常为1。
目前为止有三个版本：
* igmpv1（由RFC 1112定义）
* igmpv2（由RFC 2236定义）
* igmpv3 (由RFC 3376定义）
## igmpv2报文类型分析
* 普遍组查询（general query）：igmp查询器周期性发送常规查询报文，对网络中所有组播组进行查询。  
* 特定组查询（group-specific query）：该查询报文面向特定的组播组，用于查询该组播组内是否存在成员。（当收到leave报文的时候会连续发送两个特定组查询）
* 成员关系报告(membership report)：主机向igmp路由器发送报告报文，用于申请加入某个组播组或对查询报文进行应答。
* 成员离开报文（leave):成员离开组播组时主动向igmp路由器发送的报文，用于宣告自己离开了某个组播组。
## 报文格式分析
|版本（4bit）|类型（4bit）|最大响应时间（8bit）|校验和（16bit）|组播组地址（32bit）|  

类型：该报文类型。  
最大响应时间：（只在查询报文中设置，其他报文中为0x00）是主机用“成员关系报告报文”来响应查询包的最长等待时间，默认10s。
组播组地址：
* 普遍组查询报文中，全为0；
* 特定组查询报文中，为该组的组播地址；
* 成员关系报文或离组报文中，为目标组播组地址。
## 普遍组查询报文（General Query）分析
* 路由器使用普遍组查询报文对网段中所有主机进行查询目的地址为224.0.0.1，该查询报文面向所有组播组，报文中的租地址为0.0.0.0，网段中的组成员收到查询报文后需要向路由器回复igmp成员关系报文。
* 常规查询报文每隔60秒发一次，可以修改。
* 查询报文中的最大响应时间，为回应查询报文的最长等待时间，默认10s
* 如果组播路由器在（2*60+10=130）前仍然没有收到一个成员报告报文，那么宣布这个子网没有成员，不在向这个子网发送组播数据。
## 特定组查询报文
* 收到某组成员发送的离组报文，该路由器变会发送特定组查询，确认该组播组内还是否有其他成员存在。
* 目的地之为收到的igmp离组报文的主机所在主播组。
*
## 成员关系报告报文（0x16）
* 组成员通过发送该报文宣布自己成为组播组的成员
* 目的地址为主机期望加入的组播组地址
* 用于确认igmp查询器发送的查询报文
## leave report（0x17）
* igmpv1没有定义组成员离组方式。igmpv2增加了组成员的离组机制。
* 组成员离开组播组时，需向网络中泛洪igmp离组报文，目的地址为224.0.0.2。
* igmp收到一个离组报文时，会向这个组播组发送igmp特定组查询。
## igmpv2查询器
* 如果一个网段有多台igmp路由器，需要选举出一个igmp查询器
* 选举方法：ip地址最小的路由器充当该网段的igmp查询器。
* 若非查询器，在125s（其他查询器存活时间）后依然没有收到查询器发送的igmp查询报文，会认为该查询器已经故障，新一轮查询器选举将会触发。
## 常规查询响应
* 有多个组成员时，每个组成员收到常规查询包都会启动报告延时计时器，获得0-10s的一个随机值，计时器超时后，就会发送igmp成员关系报文。
* 若计时期超时之前，收到一个组其他pc发送的成员关系报文，则自己不再发送。
## timers
* 60s：发送常规查询报文的时间间隔
* 10s：组成员收到常规查询报文的最大响应时间。
* 1s：查询器发送两个特定查询报文之间的时间间隔。
* 2*60+10=130s：若查询器发送常规查询报文，超过130s还没有收到组成员发送的成员关系报文，则认定该网段没有组成员。
* 2*60+10/2=125s：查询器存活时间
